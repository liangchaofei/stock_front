<!--
 * @Author: your name
 * @Date: 2019-12-17 19:52:10
 * @LastEditTime : 2020-01-06 19:54:10
 * @LastEditors  : Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: /gp/static/component/list.html
 -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=0;">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>知修数据</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css">
    <link rel="stylesheet" href="../css/person.css">
</head>

<body>
    <div class="person_top">
        <img src="" alt="头像" class="tx">
        <div class="name" style="padding-bottom: 10px;"></div>
    </div>

    <div>
        <!-- <div class="weui-cell">
            <div class="weui-cell__hd"><label for="name" class="weui-label">地址</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" id="address" type="text" value="湖北省 武汉市 武昌区" readonly="">
            </div>
        </div> -->
        <div class="weui-cell" style="margin-top: 10px;">
            <div class="weui-cell__hd"><label for="name" class="weui-label" style="padding-right: 10px;color: #999;
                font-size: 13px;">会员到期时间:</label>
            </div>
            <div class="weui-cell__bd">
                <div class="weui-input" id="time"></div>
                <!-- <input class="weui-input" id="phone" type="text" value=""> -->
            </div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__hd"><label for="name" class="weui-label" style="padding-right: 10px;color: #999;
                font-size: 13px;">查询剩余次数:</label>
            </div>
            <div class="weui-cell__bd">
                <div class="weui-input" id="joinTime"></div class="weui-input" id="joinTime">
                <!-- <input class="weui-input" id="joinTime" type="text" value=""> -->
            </div>
        </div>
       
        <div class="weui-cell">
            <div class="weui-cell__hd"><label for="name" class="weui-label" style="padding-right: 10px;color: #999;
                font-size: 13px;">充值:</label>
            </div>
            <div class="weui-cell__bd">
                <div class="weui-cell weui-cell_select">
                    <div class="weui-cell__bd">
                        <select class="weui-select" id="wechat">
                            <option value='' disabled selected style='display:none;'>请选择会员等级</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="weui-btn-area" id="pay_btn" style="margin-bottom: 30px;">
            <a class="weui-btn weui-btn_primary" href="javascript:" id="showTooltips">确定</a>
        </div>
        <div class="weui-panel weui-panel_access">
            <div class="weui-panel__hd" id="open">
                邀请记录<i class="down"></i><i class="up" style="display:none;"></i>

            </div>
            <div id="invite_dom"></div>
        </div>



 
        <!-- <div class="weui-cell">
            <div class="weui-cell__hd"><label for="name" class="weui-label">我的条件</label></div>
            <div class="weui-cell__bd">
                <input class="weui-input" id="other" type="text" value="" readonly="" data-values="1,2,3">
            </div>
        </div> -->
    </div>
    <div class="weui-tabbar">
        <a href="/component/search.html" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">
                <img src="../img/icon_nav_button.png" alt="">
            </div>
            <p class="weui-tabbar__label">查询</p>
        </a>
        <a href="/component/person.html" class="weui-tabbar__item weui-bar__item--on">
            <div class="weui-tabbar__icon">
                <img src="../img/icon_nav_cell.png" alt="">
            </div>
            <p class="weui-tabbar__label">我</p>
        </a>
    </div>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js">
    </script>
    <script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/swiper.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/city-picker.min.js"></script>
    <script src="../js/jwerixin.js"></script>
    <script>

        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
            var r = window.location.search.substr(1).match(reg);  //匹配目标参数
            if (r != null) return unescape(r[2]); return null; //返回参数值
        }
        $('#invite_dom').css({ "display": "none" })
        $('#open').on('click', function () {
            $('#invite_dom').slideToggle("slow");
            $("#open .up").toggle();
            $("#open .down").toggle();
        })
        $.ajax({
            url: 'https://stock.zhixiutec.com/api/user',
            type: 'get',
            success: function (res) {
                console.log('res', res)
                var data = res.data;
                if (res.error_code === 2) {
                    window.open(data, "_self");
                } else {
                    $('.tx').attr('src', data.avatar);
                    $('.name').text(data.user_name);
                    $('#joinTime').text(data.query_left)
                    $('#time').text(data.member_expire_time.substring(0, 10))
                    $.ajax({
                        url: 'https://stock.zhixiutec.com/api/is_member',
                        success: function (res) {
                            var is_member = res.data;
                            if (is_member === false) {
                                $.ajax({
                                    url: 'https://stock.zhixiutec.com/api/payments',
                                    success: function (result) {
                                        var leader = result.data;
                                        var member = '';
                                        for (var i = 0; i < leader.length; i++) {
                                            $("#wechat").append(`<option value=${leader[i].id}>${leader[i].type_desc}</option>`);
                                        }
                                        $('#wechat').on('change', function (e) {
                                            member = parseInt(e.target.value);
                                            $('#pay_btn').on('click', function () {
                                                $.ajax({
                                                    url: 'https://stock.zhixiutec.com/api/jsapi_pay',
                                                    type: 'post',
                                                    data: JSON.stringify({ "id": member }),
                                                    success: function (res) {
                                                        console.log('res', res)
                                                        var result = res.data;
                                                        console.log('result', result)
                                                        wx.config({
                                                            debug: false,
                                                            appId: result["appId"],
                                                            timestamp: result["timeStamp"],
                                                            nonceStr: result["nonceStr"],
                                                            signature: result["signature"],
                                                            jsApiList: [
                                                                'chooseWXPay',
                                                            ]
                                                        });
                                                        wx.ready(function () {
                                                            wx.chooseWXPay({
                                                                appId: result["appId"],
                                                                timestamp: result["timeStamp"], // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                                                                nonceStr: result["nonceStr"], // 支付签名随机串，不长于 32 位
                                                                package: result["package"], // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）
                                                                signType: result["signType"], // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                                                                paySign: result["sign"], // 支付签名
                                                                success: function (res) {
                                                                    console.log('res', res)
                                                                },

                                                                fail: function (res) {
                                                                    $.hideLoading()
                                                                    // alert('支付失败!');
                                                                    toast("支付失败！请检查微信配置");
                                                                },
                                                                cancel: function (res) {

                                                                    // //支付取消
                                                                    $.hideLoading()
                                                                    toast("已取消支付！");
                                                                }
                                                            });
                                                        });

                                                    }
                                                })
                                            })

                                        })

                                    }
                                })
                            }
                        }
                    })

                    // 我的邀请
                    $.ajax({
                        url: 'https://stock.zhixiutec.com/api/my_invites',
                        success: function (res) {
                            console.log('111', res)
                            var data = res.data;
                            var invite = '';
                            if (data.length > 0) {
                                data.forEach(item => {
                                    invite += `
                                    <div class="weui-panel__bd" id="open_content">
                                        <div class="weui-media-box weui-media-box_small-appmsg">
                                            <div class="weui-cells">
                                                <a class="weui-cell weui-cell_access" href="javascript:;">
                                                    <div class="weui-cell__hd"><img

                                                            src=${item.Avatar}
                                                            alt="" style="width:25px;border-radius:50%;margin-right:5px;display:block"></div>
                                                    <div class="weui-cell__bd weui-cell_primary">
                                                        <p>${item.UserName}</p>
                                                    </div>
                                                    <span>${item.CreatedAt.substring(0,10)}</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    `
                                })
                                $('#invite_dom').append(invite)
                            } else {
                                $('#invite_dom').append(`<div>暂无邀请，快去邀请你的小伙伴吧，赢取查询次数</div>`)
                            }
                        }
                    })
                }

            }
        })

        // $.ajax({
        //     url: 'https://stock.zhixiutec.com/api/my_conditions',
        //     type: 'get',
        //     success: function (res) {
        //         var data = res.data;
        //         var arr = [];
        //         var allConditions = [];
        //         data.map(item => {
        //             var conditions = item.conditions;
        //             var belongs = conditions.belongs;
        //             var concepts = conditions.concepts;
        //             var labels = conditions.labels;
        //             var locations = conditions.locations;
        //             var organizational_form = conditions.organizational_form;
        //             var predicts = conditions.predicts;

        //             allConditions = belongs.concat(concepts).concat(labels).concat(locations).concat(organizational_form).concat(predicts)

        //             console.log('allConditions', allConditions.join(','))
        //             arr.push(allConditions.join(','))
        //         })
        //         console.log('arr', arr)
        //         $("#other").select({
        //             title: "选择我的条件",
        //             items: arr,
        //             onClose: function (e) {
        //                 console.log('eee', e)
        //             }
        //         });
        //     }
        // })
    </script>
</body>

</html>